<div class="mobile-screen complaints-page">
    <header class="app-bar">
        <button class="icon-btn" *ngIf="activeView === 'create'" (click)="showComplaintsList()">
            <i class="bi bi-arrow-left"></i>
        </button>
        <h1 class="app-title">{{ activeView === 'list' ? 'Complaints' : 'New Complaint' }}</h1>
        <button class="icon-btn" (click)="refreshComplaints()" [disabled]="isLoading" *ngIf="activeView === 'list'">
            <i class="bi bi-arrow-clockwise" [class.spinning]="isLoading"></i>
        </button>
    </header>

    <div class="screen-content">
        <!-- List View -->
        <ng-container *ngIf="activeView === 'list'">
            <!-- Status Summary Cards (Horizontal Scroll) -->
            <div class="status-summary-row">
                <div class="summary-item total">
                    <span class="val">{{ stats.total }}</span>
                    <span class="lab">Total</span>
                </div>
                <div class="summary-item pending">
                    <span class="val">{{ stats.pending }}</span>
                    <span class="lab">Pending</span>
                </div>
                <div class="summary-item resolved">
                    <span class="val">{{ stats.resolved }}</span>
                    <span class="lab">Resolved</span>
                </div>
            </div>

            <!-- List -->
            <div class="complaints-list-mobile">
                <div *ngFor="let complaint of filteredComplaints" class="complaint-card-mobile"
                    (click)="viewComplaintDetail(complaint)">
                    <div class="top-row">
                        <span class="category"><i class="bi" [ngClass]="getCategoryIcon(complaint.category)"></i> {{
                            complaint.category }}</span>
                        <span class="status-badge" [class]="getStatusClass(complaint.status || 'PENDING')">
                            {{ (complaint.status || 'PENDING').replace('_', ' ') }}
                        </span>
                    </div>
                    <h3 class="title">{{ complaint.title }}</h3>
                    <p class="desc">{{ complaint.description }}</p>
                    <div class="bottom-row">
                        <span class="date">{{ formatDate(complaint.submittedDate) }}</span>
                        <span class="priority" [class]="getPriorityClass(complaint.priority)">{{ complaint.priority
                            }}</span>
                    </div>
                </div>
            </div>

            <!-- FAB -->
            <button class="fab-btn" (click)="showCreateForm()">
                <i class="bi bi-plus-lg"></i>
            </button>
        </ng-container>

        <!-- Create View -->
        <ng-container *ngIf="activeView === 'create'">
            <div class="mobile-form">
                <div class="form-group">
                    <label>Category</label>
                    <select class="mobile-select" [(ngModel)]="newComplaint.category">
                        <option *ngFor="let cat of categories" [value]="cat">{{ cat }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <div class="priority-selector">
                        <button *ngFor="let pr of priorities" class="pr-btn"
                            [class.active]="newComplaint.priority === pr" (click)="newComplaint.priority = pr">
                            {{ pr }}
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Issue Title</label>
                    <input type="text" class="mobile-input" [(ngModel)]="newComplaint.title"
                        placeholder="Summary of issue">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea class="mobile-textarea" [(ngModel)]="newComplaint.description" rows="4"
                        placeholder="Detailed description"></textarea>
                </div>

                <!-- Image Section -->
                <div class="form-group">
                    <label>Attach Image</label>
                    <div class="image-upload-mobile" (click)="fileInput.click()" *ngIf="!hasImage">
                        <i class="bi bi-camera"></i>
                        <span>Tap to upload or take photo</span>
                        <input #fileInput type="file" (change)="onFileSelected($event)" accept="image/*" hidden>
                    </div>
                    <div class="image-preview-mobile" *ngIf="hasImage">
                        <img [src]="newComplaint.imagePreview">
                        <button class="remove-btn" (click)="removeImage()"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            </div>
        </ng-container>
    </div>

    <!-- Submit Footer -->
    <div class="bottom-footer" *ngIf="activeView === 'create'">
        <button class="btn-primary-mobile" (click)="onSubmitComplaint()" [disabled]="!isFormValid() || isSubmitting">
            <span *ngIf="!isSubmitting">Submit Complaint</span>
            <span *ngIf="isSubmitting" class="spinner-border"></span>
        </button>
    </div>

    <!-- Detail Bottom Sheet -->
    <div class="bottom-sheet-overlay" *ngIf="selectedComplaint" (click)="closeComplaintDetail()">
        <div class="bottom-sheet">
            <div class="sheet-handle"></div>
            <div class="sheet-header">
                <span class="status-badge" [class]="getStatusClass(selectedComplaint.status || 'PENDING')">
                    {{ (selectedComplaint.status || 'PENDING').replace('_', ' ') }}
                </span>
                <button class="close-btn" (click)="closeComplaintDetail()"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="sheet-body">
                <h2 class="detail-title">{{ selectedComplaint.title }}</h2>
                <div class="detail-info-grid">
                    <div class="info-item">
                        <label>Category</label>
                        <span>{{ selectedComplaint.category }}</span>
                    </div>
                    <div class="info-item">
                        <label>Priority</label>
                        <span>{{ selectedComplaint.priority }}</span>
                    </div>
                    <div class="info-item">
                        <label>Submitted</label>
                        <span>{{ formatDate(selectedComplaint.submittedDate) }}</span>
                    </div>
                </div>
                <div class="detail-desc">
                    {{ selectedComplaint.description }}
                </div>
                <div class="detail-image" *ngIf="selectedComplaint.imagePreview">
                    <img [src]="selectedComplaint.imagePreview">
                </div>
                <div class="admin-reply" *ngIf="selectedComplaint.adminResponse">
                    <label>Admin Response</label>
                    <p>{{ selectedComplaint.adminResponse }}</p>
                </div>
            </div>
        </div>
    </div>
</div>