<div class="modal-slide-in">
    <div class="modal-header d-flex align-items-center justify-content-between">
        <p class="f-18-m mb-0">
            {{ data?.tenant ? 'Edit' : 'Onboard New' }} Tenant
        </p>
        <button mat-icon-button (click)="onCancel()" class="text-muted">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>

    <div class="modal-body">
        <form #tenantForm="ngForm">
            <div class="row g-3">
                <!-- Full Name -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">Full Name</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <input matInput [(ngModel)]="tenant.fullName" name="fullName" required placeholder="John Doe" />
                    </mat-form-field>
                </div>

                <!-- Email -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">Email</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <input matInput [(ngModel)]="tenant.email" name="email" type="email" required
                            placeholder="john.doe@email.com" />
                    </mat-form-field>
                </div>

                <!-- Phone Number -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">Phone Number</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <input matInput [(ngModel)]="tenant.phone" name="phone" required placeholder="+91 9876543210" />
                    </mat-form-field>
                </div>

                <!-- Room Number -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">Room Number</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <input matInput [(ngModel)]="tenant.roomNumber" name="roomNumber" required placeholder="101" />
                    </mat-form-field>
                </div>

                <!-- Check-in Date -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">Check-in Date</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <input matInput [matDatepicker]="checkinPicker" [(ngModel)]="tenant.checkinDate"
                            name="checkinDate" required />
                        <mat-datepicker-toggle matIconSuffix [for]="checkinPicker"></mat-datepicker-toggle>
                        <mat-datepicker #checkinPicker></mat-datepicker>
                    </mat-form-field>
                </div>

                <!-- Status -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">Status</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <mat-select [(ngModel)]="tenant.status" name="status" required>
                            <mat-option value="Active">Active</mat-option>
                            <mat-option value="Inactive">Inactive</mat-option>
                            <mat-option value="Pending">Pending</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- Monthly Rent -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">Monthly Rent</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <span matTextPrefix>₹&nbsp;</span>
                        <input matInput [(ngModel)]="tenant.monthlyRent" name="monthlyRent" type="number" required
                            min="0" placeholder="8000" />
                    </mat-form-field>
                </div>

                <!-- Security Deposit -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">Security Deposit</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <span matTextPrefix>₹&nbsp;</span>
                        <input matInput [(ngModel)]="tenant.securityDeposit" name="securityDeposit" type="number"
                            required min="0" placeholder="16000" />
                    </mat-form-field>
                </div>

                <!-- Emergency Contact -->
                <div class="col-12 col-md-6">
                    <mat-label>Emergency Contact</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <input matInput [(ngModel)]="tenant.emergencyContact" name="emergencyContact"
                            placeholder="+91 9876543211" />
                    </mat-form-field>
                </div>

                <!-- Occupation -->
                <div class="col-12 col-md-6">
                    <mat-label>Occupation</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <input matInput [(ngModel)]="tenant.occupation" name="occupation"
                            placeholder="Software Engineer" />
                    </mat-form-field>
                </div>

                <!-- ID Proof Type -->
                <div class="col-12 col-md-6">
                    <mat-label class="required">ID Proof Type</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <mat-select [(ngModel)]="tenant.idProofType" name="idProofType" required
                            (selectionChange)="onIdProofTypeChange()">
                            <mat-option value="">-- Select --</mat-option>
                            <mat-option value="Aadhar Card">Aadhar Card</mat-option>
                            <mat-option value="Passport">Passport</mat-option>
                            <mat-option value="Driving License">Driving License</mat-option>
                            <mat-option value="Voter ID">Voter ID</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>

                <!-- ID Proof Upload Section -->
                <div class="col-12" *ngIf="tenant.idProofType">
                    <mat-label class="required d-block mb-2">{{ tenant.idProofType }} Upload</mat-label>
                    
                    <!-- Camera Preview -->
                    <div class="camera-preview-container" *ngIf="showCameraPreview">
                        <div class="camera-preview-wrapper">
                            <video id="cameraPreview" autoplay playsinline muted></video>
                            <div class="camera-overlay">
                                <div class="camera-frame"></div>
                            </div>
                        </div>
                        <div class="camera-controls">
                            <button mat-fab color="warn" (click)="stopCamera()" class="camera-btn">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            <button mat-fab color="primary" (click)="captureImage()" class="camera-btn capture-btn">
                                <i class="bi bi-camera"></i>
                            </button>
                            <button mat-fab color="accent" (click)="switchCamera()" class="camera-btn" 
                                    *ngIf="isMobileOrTablet">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </div>
                        <p class="camera-hint">Position the document within the frame and tap capture</p>
                    </div>

                    <!-- Upload Options Container -->
                    <div class="upload-container" *ngIf="!showCameraPreview">
                        <!-- No file selected state -->
                        <div *ngIf="!tenant.idProofFile && !capturedImageUrl; else filePreview">
                            
                            <!-- Desktop View - Only File Upload -->
                            <div *ngIf="!isMobileOrTablet" class="desktop-upload">
                                <input #idFileInput type="file" (change)="onIdFileSelected($event)"
                                    accept=".pdf,.jpg,.jpeg,.png" style="display: none">
                                <div class="upload-icon-wrapper">
                                    <i class="bi bi-cloud-arrow-up"></i>
                                </div>
                                <p class="upload-title">Drag & drop your file here</p>
                                <p class="upload-subtitle">or</p>
                                <button mat-stroked-button color="primary" (click)="idFileInput.click()">
                                    <i class="bi bi-upload me-2"></i> Browse Files
                                </button>
                                <small class="text-muted d-block mt-3">
                                    Supported formats: PDF, JPG, PNG • Max size: 5MB
                                </small>
                            </div>

                            <!-- Mobile/Tablet View - Both Options -->
                            <div *ngIf="isMobileOrTablet" class="mobile-upload">
                                <div class="upload-options">
                                    <!-- File Upload Option -->
                                    <div class="upload-option" (click)="mobileFileInput.click()">
                                        <input #mobileFileInput type="file" (change)="onIdFileSelected($event)"
                                            accept=".pdf,.jpg,.jpeg,.png" style="display: none">
                                        <div class="option-icon file-icon">
                                            <i class="bi bi-folder2-open"></i>
                                        </div>
                                        <span class="option-label">Upload File</span>
                                        <small class="option-hint">From device storage</small>
                                    </div>

                                    <div class="option-divider">
                                        <span>OR</span>
                                    </div>

                                    <!-- Camera Capture Option -->
                                    <div class="upload-option" (click)="openCamera()" *ngIf="isCameraAvailable">
                                        <div class="option-icon camera-icon">
                                            <i class="bi bi-camera"></i>
                                        </div>
                                        <span class="option-label">Take Photo</span>
                                        <small class="option-hint">Use device camera</small>
                                    </div>

                                    <!-- Native Camera Fallback (if MediaDevices not available) -->
                                    <div class="upload-option" *ngIf="!isCameraAvailable" 
                                         (click)="nativeCameraInput.click()">
                                        <input #nativeCameraInput type="file" accept="image/*" capture="environment"
                                            (change)="onNativeCameraCapture($event)" style="display: none">
                                        <div class="option-icon camera-icon">
                                            <i class="bi bi-camera"></i>
                                        </div>
                                        <span class="option-label">Take Photo</span>
                                        <small class="option-hint">Use device camera</small>
                                    </div>
                                </div>

                                <small class="text-muted d-block mt-3 text-center">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Supported: PDF, JPG, PNG • Max: 5MB
                                </small>
                            </div>
                        </div>

                        <!-- File/Image Preview -->
                        <ng-template #filePreview>
                            <div class="file-preview-container">
                                <!-- Image Preview -->
                                <div *ngIf="capturedImageUrl" class="image-preview">
                                    <img [src]="capturedImageUrl" alt="ID Proof Preview" class="preview-image">
                                    <div class="preview-badge" *ngIf="showCameraPreview === false">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <span>{{ tenant.idProofFile?.name?.includes('capture') ? 'Captured' : 'Uploaded' }}</span>
                                    </div>
                                </div>

                                <!-- PDF/Non-image Preview -->
                                <div *ngIf="!capturedImageUrl && tenant.idProofFile" class="pdf-preview">
                                    <i class="bi bi-file-earmark-pdf text-danger fs-1"></i>
                                </div>

                                <!-- File Info -->
                                <div class="file-info">
                                    <div class="file-details">
                                        <div class="file-name text-truncate">
                                            {{ tenant.idProofFile?.name || 'Captured Image' }}
                                        </div>
                                        <small class="file-size text-muted">
                                            {{ formatFileSize(tenant.idProofFile?.size) }}
                                        </small>
                                    </div>
                                    
                                    <div class="file-actions">
                                        <button mat-icon-button color="primary" 
                                                (click)="downloadFile(tenant.idProofFile)"
                                                matTooltip="Download">
                                            <i class="bi bi-download"></i>
                                        </button>
                                        <button mat-icon-button color="warn" 
                                                (click)="removeIdProof()"
                                                matTooltip="Remove">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Re-upload/Re-capture Options for Mobile -->
                                <div class="retake-options" *ngIf="isMobileOrTablet">
                                    <button mat-stroked-button color="primary" (click)="mobileRetakeInput.click()">
                                        <i class="bi bi-upload me-1"></i> Re-upload
                                    </button>
                                    <input #mobileRetakeInput type="file" (change)="onIdFileSelected($event)"
                                        accept=".pdf,.jpg,.jpeg,.png" style="display: none">
                                    
                                    <button mat-stroked-button color="accent" (click)="openCamera()" 
                                            *ngIf="isCameraAvailable">
                                        <i class="bi bi-camera me-1"></i> Retake
                                    </button>
                                </div>
                            </div>
                        </ng-template>
                    </div>
                </div>

                <!-- Address -->
                <div class="col-12">
                    <mat-label>Address</mat-label>
                    <mat-form-field appearance="outline" class="w-100 mt-1">
                        <textarea matInput rows="3" [(ngModel)]="tenant.address" name="address"
                            placeholder="123 Main Street, City, State"></textarea>
                    </mat-form-field>
                </div>
            </div>
        </form>
    </div>

    <div class="modal-footer d-flex justify-content-end gap-3">
        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="onCancel()">
            Cancel
        </button>
        <button type="button" class="btn btn-primary btn-sm" (click)="onSave()"
            [disabled]="!tenantForm.valid || (tenant.idProofType && !tenant.idProofFile)">
            <i class="bi bi-check2 me-1"></i>
            {{ data?.tenant ? 'Update' : 'Onboard' }} Tenant
        </button>
    </div>
</div>