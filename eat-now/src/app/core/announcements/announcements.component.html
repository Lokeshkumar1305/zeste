<div class="announcements-container">
  <!-- Header Section -->
  <div class="page-header mb-4">
    <div class="row align-items-center g-2">
      <div class="col-md-6">
        <h1 class="page-title">Announcements</h1>
        <p class="text-muted mb-0">Manage and send announcements to tenants</p>
      </div>
      <div class="col-md-6 text-md-end mt-3 mt-md-0">
        <button mat-raised-button color="primary" (click)="openCreateDialog()" class="btn-create">
          <i class="bi bi-plus-lg me-2"></i>
          Create Announcement
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4 stats-row">
    <div class="col-6 col-md-3 mb-3">
      <mat-card class="stat-card stat-total">
        <mat-card-content>
          <div class="stat-icon">
            <i class="bi bi-collection"></i>
          </div>
          <div class="stat-info">
            <h3>{{ stats.total }}</h3>
            <p>Total Announcements</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <mat-card class="stat-card stat-active">
        <mat-card-content>
          <div class="stat-icon">
            <i class="bi bi-broadcast"></i>
          </div>
          <div class="stat-info">
            <h3>{{ stats.active }}</h3>
            <p>Active</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <mat-card class="stat-card stat-urgent">
        <mat-card-content>
          <div class="stat-icon">
            <i class="bi bi-exclamation-circle"></i>
          </div>
          <div class="stat-info">
            <h3>{{ stats.urgent }}</h3>
            <p>Urgent</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
    <div class="col-6 col-md-3 mb-3">
      <mat-card class="stat-card stat-expiring">
        <mat-card-content>
          <div class="stat-icon">
            <i class="bi bi-clock-history"></i>
          </div>
          <div class="stat-info">
            <h3>{{ stats.expiringSoon }}</h3>
            <p>Expiring Soon</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Filters Section -->
  <mat-card class="filter-card mb-4">
    <mat-card-content>
      <div class="row align-items-center g-3">
        <div class="col-md-3">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>
              <i class="bi bi-search me-1"></i> Search
            </mat-label>
            <input matInput [(ngModel)]="searchTerm" placeholder="Search announcements..."
              (keyup.enter)="applyFilter()" />
            <button *ngIf="searchTerm" matSuffix mat-icon-button (click)="searchTerm = ''; applyFilter()">
              <i class="bi bi-x"></i>
            </button>
          </mat-form-field>
        </div>

        <div class="col-md-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Type</mat-label>
            <mat-select [(ngModel)]="selectedType" (selectionChange)="applyFilter()">
              <mat-option value="">All Types</mat-option>
              <mat-option *ngFor="let type of announcementTypes" [value]="type.value">
                <i class="bi {{ type.icon }} me-2"></i> {{ type.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Priority</mat-label>
            <mat-select [(ngModel)]="selectedPriority" (selectionChange)="applyFilter()">
              <mat-option value="">All Priorities</mat-option>
              <mat-option *ngFor="let priority of priorities" [value]="priority.value">
                {{ priority.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-2">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Status</mat-label>
            <mat-select [(ngModel)]="selectedStatus" (selectionChange)="applyFilter()">
              <mat-option value="">All Status</mat-option>
              <mat-option [value]="true">Active</mat-option>
              <mat-option [value]="false">Inactive</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-3 text-md-end">
          <div class="d-flex flex-wrap gap-2 justify-content-md-end">
            <button mat-stroked-button color="warn" (click)="clearFilters()" class="w-100 w-md-auto">
              <i class="bi bi-x-circle me-1"></i> Clear
            </button>
            <mat-button-toggle-group [(ngModel)]="viewMode" class="view-toggle">
              <mat-button-toggle value="cards">
                <i class="bi bi-grid-3x2-gap"></i>
              </mat-button-toggle>
              <mat-button-toggle value="table">
                <i class="bi bi-list-ul"></i>
              </mat-button-toggle>
            </mat-button-toggle-group>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="mt-3">Loading announcements...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && announcements.length === 0" class="empty-state">
    <mat-card class="text-center py-5">
      <i class="bi bi-megaphone display-1 text-muted"></i>
      <h3 class="mt-3">No Announcements Found</h3>
      <p class="text-muted">Create your first announcement to notify tenants.</p>
      <button mat-raised-button color="primary" (click)="openCreateDialog()">
        <i class="bi bi-plus-lg me-2"></i> Create Announcement
      </button>
    </mat-card>
  </div>

  <!-- Cards View -->
  <div *ngIf="!isLoading && announcements.length > 0 && viewMode === 'cards'" class="cards-view">
    <div class="row">
      <div class="col-sm-6 col-lg-4 mb-4" *ngFor="let announcement of announcements; trackBy: trackByFn">
        <mat-card class="announcement-card" [class.inactive]="!announcement.isActive">
          <mat-card-header>
            <div mat-card-avatar class="type-avatar" [style.backgroundColor]="getTypeInfo(announcement.type)?.color">
              <i class="bi {{ getTypeInfo(announcement.type)?.icon }}"></i>
            </div>
            <mat-card-title>{{ announcement.title }}</mat-card-title>
            <mat-card-subtitle>
              <span class="badge me-2" [ngClass]="'bg-' + getPriorityInfo(announcement.priority)?.color">
                {{ getPriorityInfo(announcement.priority)?.label }}
              </span>
              <span class="badge" [ngClass]="announcement.isActive ? 'bg-success' : 'bg-secondary'">
                {{ announcement.isActive ? 'Active' : 'Inactive' }}
              </span>
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <p class="announcement-message">
              {{ announcement.message }}
            </p>

            <div class="announcement-meta">
              <div class="meta-item">
                <i class="bi bi-people me-1"></i>
                {{ getTargetAudienceLabel(announcement.targetAudience) }}
              </div>
              <div class="meta-item">
                <i class="bi bi-calendar me-1"></i>
                {{ announcement.createdAt | date : 'MMM dd, yyyy' }}
              </div>
              <div class="meta-item" *ngIf="announcement.expiryDate">
                <i class="bi bi-clock me-1" [class.text-warning]="isExpiringSoon(announcement.expiryDate)"
                  [class.text-danger]="isExpired(announcement.expiryDate)"></i>
                <span [class.text-warning]="isExpiringSoon(announcement.expiryDate)"
                  [class.text-danger]="isExpired(announcement.expiryDate)">
                  Expires:
                  {{ announcement.expiryDate | date : 'MMM dd, yyyy' }}
                </span>
              </div>
            </div>
          </mat-card-content>

          <mat-card-actions align="end">
            <button mat-icon-button color="primary" matTooltip="Edit" (click)="openEditDialog(announcement)">
              <i class="bi bi-pencil"></i>
            </button>
            <button mat-icon-button [color]="announcement.isActive ? 'warn' : 'primary'"
              [matTooltip]="announcement.isActive ? 'Deactivate' : 'Activate'" (click)="toggleStatus(announcement)">
              <i class="bi" [ngClass]="announcement.isActive ? 'bi-pause-circle' : 'bi-play-circle'"></i>
            </button>
            <button mat-icon-button color="warn" matTooltip="Delete" (click)="deleteAnnouncement(announcement)">
              <i class="bi bi-trash"></i>
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>
  </div>

  <!-- TABLE VIEW (desktop + mobile card list) -->
  <div *ngIf="!isLoading && announcements.length > 0 && viewMode === 'table'" class="table-view-wrapper">
    <!-- Desktop table -->
    <div class="table-view-desktop">
      <mat-card class="tenant-card">
        <div class="tenant-card-header">
          <div class="tenant-card-title-wrapper">
            <h2 class="tenant-card-title">Announcement Details</h2>
            <p class="tenant-card-subtitle">
              List of all announcements with status and priority
            </p>
          </div>
        </div>

        <mat-divider></mat-divider>

        <mat-card-content class="tenant-card-content">
          <div class="table-responsive">
            <table mat-table [dataSource]="dataSource" matSort class="tenant-table">
              <!-- Type Column -->
              <ng-container matColumnDef="type">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>TYPE</th>
                <td mat-cell *matCellDef="let row">
                  <span class="type-badge" [style.backgroundColor]="getTypeInfo(row.type)?.color">
                    <i class="bi {{ getTypeInfo(row.type)?.icon }} me-1"></i>
                    {{ getTypeInfo(row.type)?.label }}
                  </span>
                </td>
              </ng-container>

              <!-- Title Column -->
              <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>TITLE</th>
                <td mat-cell *matCellDef="let row">
                  <span class="tenant-name">{{ row.title }}</span>
                  <p class="tenant-subtext">{{ row.message }}</p>
                </td>
              </ng-container>

              <!-- Priority Column -->
              <ng-container matColumnDef="priority">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  PRIORITY
                </th>
                <td mat-cell *matCellDef="let row">
                  <span class="priority-pill" [ngClass]="'priority-' + getPriorityInfo(row.priority)?.color">
                    {{ getPriorityInfo(row.priority)?.label }}
                  </span>
                </td>
              </ng-container>

              <!-- Target Audience Column -->
              <ng-container matColumnDef="targetAudience">
                <th mat-header-cell *matHeaderCellDef>TARGET</th>
                <td mat-cell *matCellDef="let row">
                  {{ getTargetAudienceLabel(row.targetAudience) }}
                </td>
              </ng-container>

              <!-- Created Date Column -->
              <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  CREATED
                </th>
                <td mat-cell *matCellDef="let row">
                  {{ row.createdAt | date : 'MMM d, y' }}
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>STATUS</th>
                <td mat-cell *matCellDef="let row">
                  <span class="status-pill" [ngClass]="row.isActive ? 'status-active' : 'status-inactive'">
                    <span class="status-dot"></span>
                    {{ row.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>ACTION</th>
                <td mat-cell *matCellDef="let row">
                  <button mat-icon-button class="icon-btn edit" matTooltip="Edit" (click)="openEditDialog(row)">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                  <button mat-icon-button class="icon-btn status"
                    [matTooltip]="row.isActive ? 'Deactivate' : 'Activate'" (click)="toggleStatus(row)">
                    <i class="bi" [ngClass]="row.isActive ? 'bi-pause-circle' : 'bi-play-circle'"></i>
                  </button>
                  <button mat-icon-button class="icon-btn delete" color="warn" matTooltip="Delete"
                    (click)="deleteAnnouncement(row)">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns" class="tenant-header-row"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns" class="tenant-data-row"
                [class.inactive-row]="!row.isActive"></tr>
            </table>
          </div>

          <!-- Pagination bar -->
          <div class="tenant-pagination-bar">
            <mat-paginator #paginator class="tenant-paginator" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions"
              aria-label="Select page of announcements" (page)="onMatPageChange($event)">
            </mat-paginator>

            <div class="page-nav">
              <!-- NOTE: removed d-none from page-btn-icon so we can control via CSS -->
              <button class="page-btn prev" [disabled]="pageIndex === 0" (click)="goToPreviousPage()">
                <span class="page-btn-text">‹ Previous</span>
                <span class="page-btn-icon">‹</span>
              </button>

              <ng-container *ngFor="let p of pages">
                <button class="page-btn number" [class.active]="p === pageIndex + 1" (click)="goToPage(p - 1)">
                  {{ p }}
                </button>
              </ng-container>

              <button class="page-btn next" [disabled]="pageIndex >= totalPages - 1" (click)="goToNextPage()">
                <span class="page-btn-text">Next ›</span>
                <span class="page-btn-icon">›</span>
              </button>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Mobile table-like cards -->
    <div class="table-view-mobile">
      <h5 class="mobile-table-title mb-2">Announcement Details</h5>
      <p class="mobile-table-subtitle mb-3">
        List of all announcements with status and priority
      </p>

      <div class="table-card" *ngFor="let row of announcements; trackBy: trackByFn">
        <div class="table-card-header">
          <span class="type-badge" [style.backgroundColor]="getTypeInfo(row.type)?.color">
            <i class="bi {{ getTypeInfo(row.type)?.icon }} me-1"></i>
            {{ getTypeInfo(row.type)?.label }}
          </span>

          <span class="priority-pill" [ngClass]="'priority-' + getPriorityInfo(row.priority)?.color">
            {{ getPriorityInfo(row.priority)?.label }}
          </span>

          <span class="status-pill" [ngClass]="row.isActive ? 'status-active' : 'status-inactive'">
            <span class="status-dot"></span>
            {{ row.isActive ? 'Active' : 'Inactive' }}
          </span>
        </div>

        <div class="table-card-body">
          <div class="table-card-title">{{ row.title }}</div>
          <p class="table-card-message">
            {{ row.message }}
          </p>

          <div class="table-card-meta">
            <div class="meta-line">
              <i class="bi bi-people me-1"></i>
              {{ getTargetAudienceLabel(row.targetAudience) }}
            </div>
            <div class="meta-line">
              <i class="bi bi-calendar me-1"></i>
              {{ row.createdAt | date : 'MMM d, y' }}
            </div>
            <div class="meta-line" *ngIf="row.expiryDate">
              <i class="bi bi-clock me-1" [class.text-warning]="isExpiringSoon(row.expiryDate)"
                [class.text-danger]="isExpired(row.expiryDate)"></i>
              <span [class.text-warning]="isExpiringSoon(row.expiryDate)"
                [class.text-danger]="isExpired(row.expiryDate)">
                Expires: {{ row.expiryDate | date : 'MMM d, y' }}
              </span>
            </div>
          </div>
        </div>

        <div class="table-card-footer">
          <button mat-icon-button color="primary" matTooltip="Edit" (click)="openEditDialog(row)">
            <i class="bi bi-pencil"></i>
          </button>
          <button mat-icon-button [color]="row.isActive ? 'warn' : 'primary'"
            [matTooltip]="row.isActive ? 'Deactivate' : 'Activate'" (click)="toggleStatus(row)">
            <i class="bi" [ngClass]="row.isActive ? 'bi-pause-circle' : 'bi-play-circle'"></i>
          </button>
          <button mat-icon-button color="warn" matTooltip="Delete" (click)="deleteAnnouncement(row)">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>