<div class="modal-slide-in">
  <div class="modal-header d-flex align-items-center justify-content-between">
    <p class="f-18-m mb-0">{{ isEditMode ? 'Edit Purchase Order' : 'Create Purchase Order' }}</p>
    <button mat-icon-button (click)="onCancel()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <div class="modal-body">
    <form #orderForm="ngForm">
      <!-- Supplier Selection -->
      <div class="row">
        <div class="col-md-6">
          <mat-label class="required">Supplier</mat-label>
          <mat-form-field appearance="outline" class="w-100 mt-1">
            <mat-select [(ngModel)]="order.supplierId" name="supplierId" required placeholder="Select Supplier">
              <mat-option *ngFor="let supplier of suppliers" [value]="supplier.id">
                {{ supplier.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div class="f-12-m text-muted mt-1" *ngIf="suppliers.length === 0">
            No suppliers available. Please add suppliers first.
          </div>
        </div>

        <div class="col-md-6">
          <mat-label class="required">Status</mat-label>
          <mat-form-field appearance="outline" class="w-100 mt-1">
            <mat-select [(ngModel)]="order.status" name="status" required>
              <mat-option value="Draft">Draft</mat-option>
              <mat-option value="Pending">Pending</mat-option>
              <mat-option value="Approved">Approved</mat-option>
              <mat-option value="Ordered">Ordered</mat-option>
              <mat-option value="Received">Received</mat-option>
              <mat-option value="Cancelled">Cancelled</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-label class="required">Order Date</mat-label>
          <mat-form-field appearance="outline" class="w-100 mt-1">
            <input matInput [matDatepicker]="orderDatePicker" [(ngModel)]="order.orderDate" name="orderDate" required>
            <mat-datepicker-toggle matIconSuffix [for]="orderDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #orderDatePicker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="col-md-6">
          <mat-label class="required">Expected Delivery Date</mat-label>
          <mat-form-field appearance="outline" class="w-100 mt-1">
            <input matInput [matDatepicker]="expectedDatePicker" [(ngModel)]="order.expectedDate" name="expectedDate"
              required>
            <mat-datepicker-toggle matIconSuffix [for]="expectedDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #expectedDatePicker></mat-datepicker>
          </mat-form-field>
        </div>
      </div>

      <!-- Add Items Section -->
      <div class="mt-4">
        <h6 class="mb-3">Add Items to Order</h6>
        <div class="row align-items-end">
          <div class="col-md-4">
            <mat-label>Select Item</mat-label>
            <mat-form-field appearance="outline" class="w-100 mt-1">
              <mat-select [(ngModel)]="selectedItemId" name="selectedItemId" (selectionChange)="onItemSelect()"
                placeholder="Choose item">
                <mat-option *ngFor="let item of availableItems" [value]="item.id">
                  {{ item.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="col-md-2">
            <mat-label>Quantity</mat-label>
            <mat-form-field appearance="outline" class="w-100 mt-1">
              <input matInput type="number" [(ngModel)]="selectedQuantity" name="selectedQuantity" min="1"
                placeholder="Qty">
            </mat-form-field>
          </div>

          <div class="col-md-3">
            <mat-label>Unit Price</mat-label>
            <mat-form-field appearance="outline" class="w-100 mt-1">
              <input matInput type="number" [(ngModel)]="selectedUnitPrice" name="selectedUnitPrice" min="0"
                placeholder="Price">
            </mat-form-field>
          </div>

          <div class="col-md-3">
            <button type="button" class="btn btn-outline-primary w-100 mb-3" (click)="addItem()"
              [disabled]="!selectedItemId || selectedQuantity <= 0">
              <i class="bi bi-plus-lg me-1"></i> Add Item
            </button>
          </div>
        </div>
      </div>

      <!-- Order Items Table -->
      <div class="mt-3" *ngIf="order.items && order.items.length > 0">
        <h6 class="mb-3">Order Items</h6>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th>Item</th>
                <th width="120">Quantity</th>
                <th width="150">Unit Price</th>
                <th width="150">Total</th>
                <th width="80">Action</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of order.items; let i = index">
                <td>{{ item.itemName }}</td>
                <td>
                  <input type="number" class="form-control form-control-sm" [(ngModel)]="item.quantity"
                    [name]="'qty_' + i" (ngModelChange)="updateItemTotal(item)" min="1">
                </td>
                <td>
                  <input type="number" class="form-control form-control-sm" [(ngModel)]="item.unitPrice"
                    [name]="'price_' + i" (ngModelChange)="updateItemTotal(item)" min="0">
                </td>
                <td class="text-end">₹{{ item.totalPrice | number:'1.2-2' }}</td>
                <td class="text-center">
                  <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeItem(i)">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="table-light">
                <td colspan="3" class="text-end"><strong>Total Amount:</strong></td>
                <td class="text-end"><strong>₹{{ order.totalAmount | number:'1.2-2' }}</strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- No Items Message -->
      <div class="alert alert-info mt-3" *ngIf="!order.items || order.items.length === 0">
        <i class="bi bi-info-circle me-2"></i>
        No items added yet. Please select items from the dropdown above.
      </div>

      <!-- Notes -->
      <div class="mt-4">
        <mat-label>Notes</mat-label>
        <mat-form-field appearance="outline" class="w-100 mt-1">
          <textarea matInput rows="3" [(ngModel)]="order.notes" name="notes"
            placeholder="Add any notes or special instructions...">
          </textarea>
        </mat-form-field>
      </div>
    </form>
  </div>

  <div class="modal-footer d-flex justify-content-end gap-2 mt-4">
    <button type="button" class="btn btn-outline-secondary" (click)="onCancel()">
      Cancel
    </button>
    <button type="button" class="btn btn-primary" (click)="onSave()"
      [disabled]="!order.supplierId || !order.items || order.items.length === 0">
      <i class="bi bi-check2 me-1"></i>
      {{ isEditMode ? 'Update Order' : 'Create Order' }}
    </button>
  </div>
</div>