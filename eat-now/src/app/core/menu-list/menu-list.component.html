<div class="hostel-menu-page page-container">
    <!-- HEADER -->
    <div class="page-header">
        <div class="title-block">
            <h2>Create Hostel Menu</h2>
            <p>Select items from your configured list to show in tenants app.</p>
            <div class="editing-badge" *ngIf="editingMenuId">
                <mat-icon>edit</mat-icon>
                <span>Editing Mode: All changes will update the existing menu.</span>
            </div>
        </div>

        <div class="header-actions">
            <button mat-stroked-button class="btn-reset" (click)="clearAll()">
                <mat-icon>refresh</mat-icon>
                <span>Reset</span>
            </button>
            <button mat-flat-button color="primary" class="btn-publish" (click)="onSaveMenu()">
                <mat-icon>{{ editingMenuId ? 'save' : 'publish' }}</mat-icon>
                <span>{{ editingMenuId ? 'Update Menu' : 'Publish Menu' }}</span>
            </button>
        </div>
    </div>

    <!-- MODE TOGGLE -->
    <div class="mode-toggle-section">
        <div class="mode-toggle-label">Create menu for:</div>
        <mat-button-toggle-group [value]="menuMode" (change)="onModeChange($event.value)" class="mode-toggle-group">
            <mat-button-toggle value="DATE">
                <mat-icon>calendar_today</mat-icon>
                <span>Specific Date</span>
            </mat-button-toggle>
            <mat-button-toggle value="DAY_OF_WEEK">
                <mat-icon>date_range</mat-icon>
                <span>Day of Week</span>
            </mat-button-toggle>
        </mat-button-toggle-group>
    </div>

    <!-- BODY CONTENT -->
    <div class="layout-grid">
        <!-- LEFT PANEL: BUILDER -->
        <div class="left-panel">
            <form [formGroup]="menuForm" class="menu-filters">
                <!-- Date Mode Specific -->
                <ng-container *ngIf="menuMode === 'DATE'">
                    <mat-form-field appearance="outline" class="filter-field">
                        <mat-label>Menu Date</mat-label>
                        <input matInput [matDatepicker]="datePicker" formControlName="date" />
                        <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
                        <mat-datepicker #datePicker></mat-datepicker>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="filter-field">
                        <mat-label>Repeat</mat-label>
                        <mat-select formControlName="recurrence">
                            <mat-option *ngFor="let opt of recurrenceOptions" [value]="opt.value">{{ opt.label
                                }}</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="filter-field"
                        *ngIf="menuForm.get('recurrence')?.value !== 'ONE_TIME'">
                        <mat-label>Valid Till</mat-label>
                        <input matInput [matDatepicker]="validTillPicker" formControlName="validTill" />
                        <mat-datepicker-toggle matSuffix [for]="validTillPicker"></mat-datepicker-toggle>
                        <mat-datepicker #validTillPicker></mat-datepicker>
                    </mat-form-field>
                </ng-container>

                <!-- Day Mode Specific -->
                <ng-container *ngIf="menuMode === 'DAY_OF_WEEK'">
                    <mat-form-field appearance="outline" class="filter-field">
                        <mat-label>Select Day</mat-label>
                        <mat-select formControlName="dayOfWeek">
                            <mat-option *ngFor="let day of daysOfWeek; trackBy: trackByDay" [value]="day.value">
                                <div class="d-flex justify-content-between w-100">
                                    <span>{{ day.label }}</span>
                                    <small class="text-muted" *ngIf="getMenuCountForDay(day.value) > 0">
                                        {{ getMenuCountForDay(day.value) }} menu(s)
                                    </small>
                                </div>
                            </mat-option>
                        </mat-select>
                    </mat-form-field>

                    <div class="day-info-chip">
                        <mat-icon>event_repeat</mat-icon>
                        <span>This menu will repeat every {{ getDayLabel(selectedDayOfWeek) }}</span>
                    </div>
                </ng-container>

                <!-- Common -->
                <mat-form-field appearance="outline" class="filter-field">
                    <mat-label>Meal Type</mat-label>
                    <mat-select formControlName="mealType">
                        <mat-option *ngFor="let type of availableMealTypes" [value]="type">{{ type }}</mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field" style="max-width: 140px;">
                    <mat-label>From</mat-label>
                    <input matInput type="time" formControlName="serveFrom" />
                    <mat-icon matSuffix>schedule</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field" style="max-width: 140px;">
                    <mat-label>Till</mat-label>
                    <input matInput type="time" formControlName="serveTo" />
                    <mat-icon matSuffix>history</mat-icon>
                </mat-form-field>
            </form>

            <div class="search-row">
                <mat-form-field appearance="outline" class="search-field">
                    <mat-icon matPrefix>search</mat-icon>
                    <input matInput placeholder="Search items..." [value]="searchText"
                        (input)="onSearchChange($any($event.target).value)" />
                </mat-form-field>

                <div class="selection-summary">
                    <div class="selected-count">
                        <mat-icon>check_circle</mat-icon>
                        <span>{{ selectedItemIds.size }} items selected</span>
                    </div>
                    <button mat-button class="select-all-btn" color="primary" (click)="selectAllVisible()">Select
                        All</button>
                    <button mat-button class="clear-btn" color="warn" (click)="clearSelection()"
                        [disabled]="!selectedItemIds.size">Clear</button>
                </div>
            </div>

            <mat-divider></mat-divider>

            <div class="menu-grid" *ngIf="filteredItems.length; else noItems">
                <div *ngFor="let item of filteredItems" class="menu-card" [class.selected-card]="isSelected(item)"
                    (click)="onCardClick(item)">
                    <mat-checkbox class="card-checkbox" [checked]="isSelected(item)" (click)="$event.stopPropagation()"
                        (change)="toggleSelection(item, $event)"></mat-checkbox>

                    <div class="image-wrapper">
                        <img [src]="item.imageUrl || defaultImage" [alt]="item.itemName" />
                        <span class="item-type-badge" [ngClass]="item.itemType.toLowerCase()">
                            {{ item.itemType }}
                        </span>
                    </div>

                    <div class="card-body">
                        <div class="title-row">
                            <h3>{{ item.itemName }}</h3>
                            <span class="meal-chip">{{ item.mealType }}</span>
                        </div>
                        <p class="description">{{ item.description }}</p>
                    </div>
                </div>
            </div>

            <ng-template #noItems>
                <div class="empty-state">
                    <mat-icon>fastfood</mat-icon>
                    <h3>No items found</h3>
                    <p>Try changing your filters or add items in Menu Config.</p>
                </div>
            </ng-template>
        </div>

        <!-- RIGHT PANEL: SUMMARY -->
        <div class="right-panel">
            <!-- DATE VIEW -->
            <ng-container *ngIf="menuMode === 'DATE'">
                <div class="right-header">
                    <mat-icon>event_available</mat-icon>
                    <div>
                        <h3>Daily Schedule</h3>
                        <p *ngIf="selectedDateDisplay">{{ selectedDateDisplay | date: 'EEE, dd MMM yyyy' }}</p>
                    </div>
                </div>

                <div class="menu-summary" *ngFor="let m of menusForSelectedDate"
                    [class.editing-highlight]="editingMenuId === m.id">
                    <div class="summary-header">
                        <div class="summary-info">
                            <div class="meal-title">
                                <mat-icon>restaurant</mat-icon>
                                <span>{{ m.mealType }}</span>
                            </div>
                            <div class="time-range">
                                <mat-icon>schedule</mat-icon>
                                <span>{{ m.serveFrom }} - {{ m.serveTo }}</span>
                                <span *ngIf="m.recurrence !== 'ONE_TIME'" class="fw-bold">• {{
                                    getRecurrenceLabel(m.recurrence) }}</span>
                            </div>
                        </div>
                        <div class="summary-right">
                            <button mat-icon-button (click)="onEditPublished(m)"
                                matTooltip="Edit"><mat-icon>edit_note</mat-icon></button>
                            <button mat-icon-button color="warn" (click)="onDeletePublished(m.id)"
                                matTooltip="Delete"><mat-icon>delete_outline</mat-icon></button>
                            <mat-form-field appearance="outline" class="status-field">
                                <mat-select [value]="m.status" (selectionChange)="onStatusChange(m, $event.value)">
                                    <mat-option value="AVAILABLE">Available</mat-option>
                                    <mat-option value="COMPLETED">Completed</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="items-list">
                        <div class="items-header">Items ({{ getMenuItemsCount(m.id) }})</div>
                        <div class="item-row" [class.item-completed]="it.status === 'COMPLETED'"
                            *ngFor="let it of getMenuItems(m.id)">
                            <div class="item-name">
                                <span class="item-type-dot" [ngClass]="it.menuItem.itemType.toLowerCase()"></span>
                                {{ it.menuItem.itemName }}
                            </div>
                            <mat-form-field appearance="outline" class="item-status-field">
                                <mat-select [value]="it.status"
                                    (selectionChange)="onItemStatusChange(m, it.menuItem.id, $event.value)">
                                    <mat-option value="AVAILABLE">Available</mat-option>
                                    <mat-option value="COMPLETED">Completed</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <div class="empty-right" *ngIf="!menusForSelectedDate.length">
                    <mat-icon>notifications_paused</mat-icon>
                    <h3>No menus for today</h3>
                    <p>Use the builder to publish a new menu.</p>
                </div>
            </ng-container>

            <!-- WEEKLY VIEW -->
            <ng-container *ngIf="menuMode === 'DAY_OF_WEEK'">
                <div class="right-header">
                    <mat-icon>view_week</mat-icon>
                    <div>
                        <h3>Weekly Schedule</h3>
                        <p>Plan your default weekly routine.</p>
                    </div>
                </div>

                <div class="day-tabs">
                    <button *ngFor="let day of daysOfWeek" [class.active-day]="selectedViewDay === day.value"
                        (click)="onViewDayChange(day.value)">
                        {{ day.short }}
                        <span class="day-badge" *ngIf="getMenuCountForDay(day.value) > 0">{{
                            getMenuCountForDay(day.value) }}</span>
                    </button>
                </div>

                <div class="menu-summary" *ngFor="let m of menusForSelectedDay"
                    [class.editing-highlight]="editingMenuId === m.id">
                    <div class="summary-header">
                        <div class="summary-info">
                            <div class="meal-title">
                                <mat-icon>restaurant</mat-icon>
                                <span>{{ m.mealType }}</span>
                            </div>
                            <div class="time-range">
                                <mat-icon>schedule</mat-icon>
                                <span>{{ m.serveFrom }} - {{ m.serveTo }}</span>
                                <span class="fw-bold">• Every {{ getDayLabel(m.dayOfWeek) }}</span>
                            </div>
                        </div>
                        <div class="summary-right">
                            <button mat-icon-button (click)="onEditPublished(m)"
                                matTooltip="Edit"><mat-icon>edit_note</mat-icon></button>
                            <button mat-icon-button color="warn" (click)="onDeletePublished(m.id)"
                                matTooltip="Delete"><mat-icon>delete_outline</mat-icon></button>
                            <mat-form-field appearance="outline" class="status-field">
                                <mat-select [value]="m.status" (selectionChange)="onStatusChange(m, $event.value)">
                                    <mat-option value="AVAILABLE">Available</mat-option>
                                    <mat-option value="COMPLETED">Completed</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>

                    <div class="items-list">
                        <div class="items-header">Included Items</div>
                        <div class="item-row" [class.item-completed]="it.status === 'COMPLETED'"
                            *ngFor="let it of getMenuItems(m.id)">
                            <div class="item-name">
                                <span class="item-type-dot" [ngClass]="it.menuItem.itemType.toLowerCase()"></span>
                                {{ it.menuItem.itemName }}
                            </div>
                            <mat-form-field appearance="outline" class="item-status-field">
                                <mat-select [value]="it.status"
                                    (selectionChange)="onItemStatusChange(m, it.menuItem.id, $event.value)">
                                    <mat-option value="AVAILABLE">Available</mat-option>
                                    <mat-option value="COMPLETED">Completed</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                </div>

                <div class="empty-right" *ngIf="!menusForSelectedDay.length">
                    <mat-icon>calendar_view_day</mat-icon>
                    <h3>Empty Day</h3>
                    <p>No default menus set for {{ getDayLabel(selectedViewDay) }}.</p>
                </div>
            </ng-container>
        </div>
    </div>
</div>